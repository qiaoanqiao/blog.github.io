<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-CN"><head><meta charset="UTF-8"><meta name="generator" content="Hexo 3.9.0"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.3.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.3.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.3.0"><link rel="mask-icon" href="/images/logo.svg?v=7.3.0" color="#222"><link rel="stylesheet" href="/css/main.css?v=7.3.0"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0"><link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"7.3.0",sidebar:{position:"left",display:"post",offset:12,onmobile:!1},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},save_scroll:!1,copycode:{enable:!1,show_result:!1,style:null},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.xml",tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},translation:{copy_button:"复制",copy_success:"复制成功",copy_failure:"复制失败"}}</script><meta name="description" content="node.js实现mqtt 发布/发送 消息到主题标签（空格分隔）： mqtt    mqtt是啥?我的博客有写这个东西:传送门  安装首先你要安装node.js和npm 教程传送门 随后找个文件夹执行 命令行 安装mqtt模块; 1npm install mqtt  如果需要服务端 执行 1npm install mosca  使用 mqtt的文档 以下代码中有些参数可以从mqtt官方文档中得到"><meta name="keywords" content="mqtt"><meta property="og:type" content="article"><meta property="og:title" content="node.js实现mqtt 发布&#x2F;发送 消息到主题"><meta property="og:url" content="https://www.fenxiangy.com/technology//nodejs-implements-mqtt-publishsend-message-to-topic.html"><meta property="og:site_name" content="分享哟"><meta property="og:description" content="node.js实现mqtt 发布/发送 消息到主题标签（空格分隔）： mqtt    mqtt是啥?我的博客有写这个东西:传送门  安装首先你要安装node.js和npm 教程传送门 随后找个文件夹执行 命令行 安装mqtt模块; 1npm install mqtt  如果需要服务端 执行 1npm install mosca  使用 mqtt的文档 以下代码中有些参数可以从mqtt官方文档中得到"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://www.fenxiangy.com/usr/uploads/2018/07/3649892521.jpg"><meta property="og:image" content="https://www.fenxiangy.com/wp-content/uploads/2018/03/9150e4e5gw1fbcgvwv9prg209w05kqv5.gif"><meta property="og:image" content="http://ww4.sinaimg.cn/large/9150e4e5ly1fjsmzvyyvpg206o06odfw.gif"><meta property="og:updated_time" content="2019-08-05T08:09:34.209Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="node.js实现mqtt 发布&#x2F;发送 消息到主题"><meta name="twitter:description" content="node.js实现mqtt 发布/发送 消息到主题标签（空格分隔）： mqtt    mqtt是啥?我的博客有写这个东西:传送门  安装首先你要安装node.js和npm 教程传送门 随后找个文件夹执行 命令行 安装mqtt模块; 1npm install mqtt  如果需要服务端 执行 1npm install mosca  使用 mqtt的文档 以下代码中有些参数可以从mqtt官方文档中得到"><meta name="twitter:image" content="https://www.fenxiangy.com/usr/uploads/2018/07/3649892521.jpg"><link rel="canonical" href="https://www.fenxiangy.com/technology//nodejs-implements-mqtt-publishsend-message-to-topic"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,isPage:!1,isArchive:!1}</script><title>node.js实现mqtt 发布/发送 消息到主题 | 分享哟</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c0261b738d8ce7c4fcea76f72faec843";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">分享哟</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">很少有人懂天秤, 以前没有. 以后也没有。</p></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content page-post-detail"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://www.fenxiangy.com/technology/nodejs-implements-mqtt-publishsend-message-to-topic.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Murry"><meta itemprop="description" content="分享哟,php程序猿,php博客,phpblog"><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="分享哟"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">node.js实现mqtt 发布/发送 消息到主题</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-07-10 11:15:00" itemprop="dateCreated datePublished" datetime="2018-07-10T11:15:00+08:00">2018-07-10</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2019-08-05 16:09:34" itemprop="dateModified" datetime="2019-08-05T16:09:34+08:00">2019-08-05</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/technology/" itemprop="url" rel="index"><span itemprop="name">技术栈</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <span class="post-meta-item-text">评论数：</span><a href="/technology/nodejs-implements-mqtt-publishsend-message-to-topic.html#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/technology/nodejs-implements-mqtt-publishsend-message-to-topic.html" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="node-js实现mqtt-发布-发送-消息到主题"><a href="#node-js实现mqtt-发布-发送-消息到主题" class="headerlink" title="node.js实现mqtt 发布/发送 消息到主题"></a>node.js实现mqtt 发布/发送 消息到主题</h1><p>标签（空格分隔）： mqtt</p><hr><p><img src="https://www.fenxiangy.com/usr/uploads/2018/07/3649892521.jpg" alt="u=2264770358,3320226800&amp;fm=27&amp;gp=0.jpg"></p><ul><li>mqtt是啥?我的博客有写这个东西:<a href="https://www.fenxiangy.com/note/mqttprotocol.html">传送门</a><br><img src="https://www.fenxiangy.com/wp-content/uploads/2018/03/9150e4e5gw1fbcgvwv9prg209w05kqv5.gif" alt="此处输入图片的描述"></li></ul><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>首先你要安装node.js和npm <a href="https://www.liaoxuefeng.com/wiki/001434446689867b27157e896e74d51a89c25cc8b43bdb3000/00143450141843488beddae2a1044cab5acb5125baf0882000" target="_blank" rel="noopener">教程传送门</a></p><p>随后找个文件夹执行 命令行 安装mqtt模块;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install mqtt</span><br></pre></td></tr></table></figure><p>如果需要服务端 执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install mosca</span><br></pre></td></tr></table></figure><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ul><li><a href="https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/02-ControlPacketFormat.html#221-mqtt%E6%8E%A7%E5%88%B6%E6%8A%A5%E6%96%87%E7%9A%84%E7%B1%BB%E5%9E%8B-mqtt-control-packet-type" target="_blank" rel="noopener">mqtt的文档</a> 以下代码中有些参数可以从mqtt官方文档中得到解释</li><li><a href="https://www.npmjs.com/package/mqtt" target="_blank" rel="noopener">node.js中mqtt模块文档</a></li><li><a href="https://www.fenxiangy.com/note/mqttprotocol.html">mqtt协议入门文章</a></li></ul><h4 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">var mosca = require(&apos;mosca&apos;);</span><br><span class="line">//构建自带服务器</span><br><span class="line">var MqttServer = new mosca.Server(&#123;</span><br><span class="line">    port: 1883</span><br><span class="line">&#125;);</span><br><span class="line">//对服务器端口进行配置， 在此端口进行监听</span><br><span class="line">MqttServer.on(&apos;clientConnected&apos;, function(client) &#123;</span><br><span class="line">    //监听连接</span><br><span class="line">    console.log(&apos;client connected&apos;, client.id);</span><br><span class="line">&#125;);</span><br><span class="line">/**</span><br><span class="line"> * 监听MQTT主题消息</span><br><span class="line"> **/</span><br><span class="line">MqttServer.on(&apos;published&apos;, function(packet, client) &#123;</span><br><span class="line">    //当客户端有连接发布主题消息</span><br><span class="line">    var topic = packet.topic;</span><br><span class="line">    console.log(packet);</span><br><span class="line">    switch (topic) &#123;</span><br><span class="line">        case &apos;test&apos;:</span><br><span class="line">            console.log(&apos;message-publish&apos;, packet.payload.toString());</span><br><span class="line">            //MQTT转发主题消息</span><br><span class="line">            MqttServer.publish(&#123; topic: &apos;other&apos;, payload: &apos;sssss&apos; &#125;);</span><br><span class="line">            break;</span><br><span class="line">        case &apos;other&apos;:</span><br><span class="line">            console.log(&apos;message-123&apos;, packet.payload.toString());</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">MqttServer.on(&apos;ready&apos;, function() &#123;</span><br><span class="line">    //当服务开启时</span><br><span class="line">    console.log(&apos;mqtt is running...&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>PS: 不推荐node.js 作服务端</code></p><h4 id="发布消息到主题"><a href="#发布消息到主题" class="headerlink" title="发布消息到主题"></a>发布消息到主题</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var mqtt = require(&apos;mqtt&apos;);</span><br><span class="line">var client = mqtt.connect(&apos;mqtt://127.0.0.1&apos;); //连接到服务端</span><br><span class="line">//client.subscribe(&apos;presence&apos;);</span><br><span class="line">var num = 0;</span><br><span class="line">var qtt = &#123;&#125;; //定义消息（可以为字符串、对象等）</span><br><span class="line">qtt = &apos;setr=xxxxxxx1xx&apos;;</span><br><span class="line">setInterval(function() &#123; //一秒钟发送一次 消息到主题 SN69143809293670state 消息为 setr=xxxxxxx1xx</span><br><span class="line">    client.publish(&apos;SN69143809293670state&apos;, qtt, &#123; qos: 0, retain: true &#125;);  </span><br><span class="line">&#125;, 1000);</span><br></pre></td></tr></table></figure><h4 id="订阅主题"><a href="#订阅主题" class="headerlink" title="订阅主题"></a>订阅主题</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var mqtt = require(&apos;mqtt&apos;);  </span><br><span class="line">var client2 = mqtt.connect(&quot;mqtt://127.0.0.1:1883&quot;);   //指定服务端地址和端口</span><br><span class="line">  </span><br><span class="line">client2.subscribe(&apos;test&apos;,&#123;qos:1&#125;);//订阅主题为test的消息  </span><br><span class="line">  </span><br><span class="line">client2.on(&apos;message&apos;,function(top,message) &#123;  </span><br><span class="line">    console.log(message.toString());  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="制作接口-简化"><a href="#制作接口-简化" class="headerlink" title="制作接口(简化)"></a>制作接口(简化)</h4><p>我所接触的这个物理设备是发送给他一个 控制 或者 查询 请求到<code>他订阅的</code>主题中(ctr),<br>并且它接收到控制信息,去执行.执行成功时 则会将 <code>状态</code> 发送到另一个 <code>我订阅的</code>主题中 .<br>使用php实现比较麻烦,并且返回信息时有时无,使用node.js更方便,返回信息也更快;</p><p>物理环境 :centos7.2 64位,装有mqtt服务代理端<code>mosquitto</code>或其他mqtt协议代理. 安装可以自行搜索一下 和 node.js;</p><ul><li>需要安装http 和 express 以及 mqtt 模块 <code>npm install 模块名</code></li><li><a href="http://nodejs.cn/api/http.html" target="_blank" rel="noopener">node.js http模块文档</a></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">var mqtt = require(&apos;mqtt&apos;);</span><br><span class="line">var express = require(&quot;express&quot;);</span><br><span class="line">var app = express();</span><br><span class="line">var hostName = &apos;127.0.0.1&apos;; //http服务的提供服务ip</span><br><span class="line">var port = 8080;</span><br><span class="line">var num = 1;</span><br><span class="line">person = new Object();</span><br><span class="line">person.firstname = &quot;Bill&quot;;</span><br><span class="line">app.all(&apos;*&apos;, function(req, res, next) &#123;</span><br><span class="line">    res.header(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</span><br><span class="line">    res.header(&quot;Access-Control-Allow-Headers&quot;, &quot;Origin, X-Requested-With, Content-Type, Accept&quot;);</span><br><span class="line">    res.header(&quot;Access-Control-Allow-Methods&quot;, &quot;PUT,POST,GET,DELETE,OPTIONS&quot;);</span><br><span class="line">    res.header(&quot;X-Powered-By&quot;, &apos; 3.2.1&apos;)</span><br><span class="line">    res.header(&quot;Content-Type&quot;, &quot;application/json;charset=utf-8&quot;);</span><br><span class="line">    next();</span><br><span class="line">&#125;);//json header头</span><br><span class="line"></span><br><span class="line">app.get(&quot;/zhinengjiaju/get&quot;, function(req, res) &#123;</span><br><span class="line">    //如果有get请求/zhinengjiaju/get则执行回调中的代码(方便!)</span><br><span class="line">    </span><br><span class="line">    // console.log(&quot;请求url：&quot;, req.path)</span><br><span class="line">    // console.log(&quot;请求参数：&quot;, req.query)</span><br><span class="line">    req.setTimeout(200); </span><br><span class="line">    //设置请求建立200ms 就中断接受请求,但还是在接收到返回信息后返回给它</span><br><span class="line">    var client = mqtt.connect(&apos;mqtt://127.0.0.1:1883&apos;, &#123;</span><br><span class="line">        username: &apos;username&apos;,</span><br><span class="line">        password: &apos;password&apos;,</span><br><span class="line">        clientId: &apos;ap&apos; + num</span><br><span class="line">    &#125;);</span><br><span class="line">    //建立连接</span><br><span class="line">    client.on(&apos;connect&apos;, function() &#123;</span><br><span class="line">        var sn = req.query.sn;</span><br><span class="line">        var k = parseInt(req.query.k) - 1;</span><br><span class="line">        // 127.0.0.1:8080/zhinengjiaju/get?sn=SN69143809293670&amp;k=1&amp;v=3&amp;cmd=setr</span><br><span class="line">        </span><br><span class="line">        client.subscribe(sn + &apos;state&apos;, &#123; qos: 1 &#125;);</span><br><span class="line">        //开始订阅</span><br><span class="line">        </span><br><span class="line">        if (req.query.cmd != &apos;setr&apos;) &#123;</span><br><span class="line">            m = req.query.cmd;</span><br><span class="line">            if (req.query.cmd == &apos;qk&apos;) &#123;</span><br><span class="line">                m = &apos;setr=1111111111&apos;;</span><br><span class="line">            &#125;</span><br><span class="line">            if (req.query.cmd == &apos;qg&apos;) &#123;</span><br><span class="line">                m = &apos;setr=0000000000&apos;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            var m = [&apos;x&apos;, &apos;x&apos;, &apos;x&apos;, &apos;x&apos;, &apos;x&apos;, &apos;x&apos;, &apos;x&apos;, &apos;x&apos;, &apos;x&apos;, &apos;x&apos;];</span><br><span class="line">            m[k] = req.query.v;;</span><br><span class="line"></span><br><span class="line">            m = req.query.cmd + &apos;=&apos; + m.join(&apos;&apos;);</span><br><span class="line">        &#125;</span><br><span class="line">        //一系列简单接口处理</span><br><span class="line"></span><br><span class="line">        client.publish(sn + &apos;ctr&apos;, m, &#123; qos: 1, retain: true &#125;); // &apos;Hello mqtt &apos; + (num++)</span><br><span class="line">        //发送</span><br><span class="line">        client.end();</span><br><span class="line">        //发送完后立即结束此次和服务端建立的请求</span><br><span class="line">    &#125;);</span><br><span class="line">    client.on(&apos;message&apos;, function(topic, message) &#123; </span><br><span class="line">        //订阅信息一直在运行,如果有设备返回信息到主题,就执行此回调</span><br><span class="line">        aaak(message.toString());</span><br><span class="line">        //将值通过aaak函数传递给res.end返回给页面数据;</span><br><span class="line">        client.end();</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    function aaak(aaaa) &#123;</span><br><span class="line">        var objaaaa = JSON.parse(aaaa);</span><br><span class="line">        // console.log(objaaaa);</span><br><span class="line">        num++;</span><br><span class="line">        client.end();</span><br><span class="line">        res.end(aaaa);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(port, hostName, function() &#123;</span><br><span class="line">    console.log(`服务器运行在http://$&#123;hostName&#125;:$&#123;port&#125;`);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>谢谢支持,感觉不错打个赏;<br><img src="http://ww4.sinaimg.cn/large/9150e4e5ly1fjsmzvyyvpg206o06odfw.gif" alt="打赏"></p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/mqtt/" rel="tag"># mqtt</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/note/docker-image-download-delete-view-command-parameters-detailed.html" rel="next" title="Docker镜像下载\删除\查看命令_参数详解"><i class="fa fa-chevron-left"></i> Docker镜像下载\删除\查看命令_参数详解</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/mo-ren-fen-lei/generate-pdf-documents-from-html-pages-using-php.html" rel="prev" title="利用PHP将HTML页面生成PDF文档">利用PHP将HTML页面生成PDF文档<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Murry</p><div class="site-description motion-element" itemprop="description">分享哟,php程序猿,php博客,phpblog</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">26</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">20</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/qiaoanqiao" title="GitHub &rarr; https://github.com/qiaoanqiao" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="/fenxiangy@163.com" title="E-Mail &rarr; fenxiangy@163.com"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#node-js实现mqtt-发布-发送-消息到主题"><span class="nav-number">1.</span> <span class="nav-text">node.js实现mqtt 发布/发送 消息到主题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">1.0.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用"><span class="nav-number">1.0.2.</span> <span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#服务端"><span class="nav-number">1.0.2.1.</span> <span class="nav-text">服务端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#发布消息到主题"><span class="nav-number">1.0.2.2.</span> <span class="nav-text">发布消息到主题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#订阅主题"><span class="nav-number">1.0.2.3.</span> <span class="nav-text">订阅主题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#制作接口-简化"><span class="nav-number">1.0.2.4.</span> <span class="nav-text">制作接口(简化)</span></a></li></ol></li></ol></li></ol></div></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2015 – <span itemprop="copyrightYear">2019</span><span class="with-love" id="animate"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">Murry</span></div><div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div><span class="post-meta-divider">|</span><div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.3.0</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script src="/lib/jquery/index.js?v=3.4.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script><script src="/lib/unpkg.com/valine/dist/Valine.min.js"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/js/utils.js?v=7.3.0"></script><script src="/js/motion.js?v=7.3.0"></script><script src="/js/schemes/muse.js?v=7.3.0"></script><script src="/js/next-boot.js?v=7.3.0"></script><script src="/js/local-search.js?v=7.3.0"></script><script src="/js/scrollspy.js?v=7.3.0"></script><script src="/js/post-details.js?v=7.3.0"></script><script>var GUEST=["nick","mail","link"],guest="nick,mail,link";guest=guest.split(",").filter(function(a){return-1<GUEST.indexOf(a)}),new Valine({el:"#comments",verify:!1,notify:!1,appId:"5MAshWrT8VHdC9f9YLj5g6xG-MdYXbMMI",appKey:"n8k126UjSFx0MaQvxcMuyoa0",placeholder:"Just go go",avatar:"mm",meta:guest,pageSize:"10",visitor:!1,lang:"zh-Hans",path:location.pathname})</script></body></html>